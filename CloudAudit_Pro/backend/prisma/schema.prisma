// =============================================================================
// CLOUDAUDIT PRO - DATABASE SCHEMA
// =============================================================================
// This is the main Prisma schema file for CloudAudit Pro
// Organized in logical sections for better maintainability
// Learn more: https://pris.ly/d/prisma-schema
// =============================================================================

// =============================================================================
// CONFIGURATION
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// SUPER ADMIN & APPROVAL WORKFLOW MODELS
// =============================================================================
// System-level administration and approval workflows

model SuperAdmin {
  id           String @id @default(cuid())
  email        String @unique
  passwordHash String
  firstName    String
  lastName     String
  role         String @default("SUPER_ADMIN")
  isActive     Boolean @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenantApprovals TenantApprovalRequest[]

  @@map("super_admins")
}

model TenantApprovalRequest {
  id          String @id @default(cuid())
  tenantId    String
  requestedBy String
  status      TenantApprovalStatus @default(PENDING)
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requester TenantUser @relation(fields: [requestedBy], references: [id])
  reviewer  SuperAdmin? @relation(fields: [reviewedBy], references: [id])

  @@map("tenant_approval_requests")
}

model UserApprovalRequest {
  id            String @id @default(cuid())
  tenantId      String
  userId        String
  requestedBy   String
  approvalType  UserApprovalType @default(REGISTRATION)
  status        UserApprovalStatus @default(PENDING)
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNotes   String?
  requestedRole String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      TenantUser @relation("UserRequests", fields: [userId], references: [id], onDelete: Cascade)
  requester TenantUser @relation("RequestedBy", fields: [requestedBy], references: [id])
  reviewer  TenantUser? @relation("ReviewedBy", fields: [reviewedBy], references: [id])

  @@map("user_approval_requests")
}

enum TenantApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  REQUIRES_CHANGES
}

enum UserApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  REQUIRES_CHANGES
}

enum UserApprovalType {
  REGISTRATION
  ROLE_CHANGE
  ACCESS_REQUEST
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

// =============================================================================
// MULTI-TENANT MANAGEMENT MODELS
// =============================================================================
// Core tenant infrastructure for SaaS architecture
model Tenant {
  id           String @id @default(cuid())
  name         String
  subdomain    String @unique
  databaseName String @unique

  // Subscription details
  subscriptionTier String @default("trial")
  maxUsers         Int    @default(10)
  maxCompanies     Int    @default(5)
  storageLimitGb   Int    @default(10)

  // Status and lifecycle
  status           TenantStatus @default(PENDING)
  approvalStatus   TenantApprovalStatus @default(PENDING)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  suspendedAt      DateTime?
  trialEndsAt      DateTime?
  approvedBy       String?
  approvedAt       DateTime?
  rejectedReason   String?

  // Billing
  billingEmail   String?
  billingAddress Json?

  // Configuration
  featureFlags Json @default("{}")
  customConfig Json @default("{}")
  settings     Json @default("{}")
  metadata     Json @default("{}")
  contactInfo  Json @default("{}")
  deletedAt    DateTime?

  // Relations
  users                 TenantUser[]
  subscriptions         Subscription[]
  usageMetrics          UsageMetric[]
  documents             Document[]
  systemUsers           User[]
  accountHeads          AccountHead[] @relation("TenantAccountHeads")
  approvalRequests      TenantApprovalRequest[]
  userApprovalRequests  UserApprovalRequest[]
  procedureTemplates    ProcedureTemplate[]
  auditProcedures       AuditProcedure[]
  workpapers            Workpaper[]
  findings              Finding[]
  procedureComments     ProcedureComment[]

  @@map("tenants")
}

model TenantUser {
  id               String @id @default(cuid())
  tenantId         String
  email            String
  passwordHash     String
  firstName        String?
  lastName         String?
  role             String @default("USER")
  status           UserStatus @default(PENDING)
  approvalStatus   UserApprovalStatus @default(PENDING)
  isActive         Boolean @default(false)
  
  // Invitation and approval tracking
  invitedBy        String?
  invitedAt        DateTime?
  approvedBy       String?
  approvedAt       DateTime?
  
  // Additional user information
  jobTitle         String?
  department       String?
  phoneNumber      String?
  
  // Password management
  requirePasswordChange Boolean @default(false)
  passwordResetAt       DateTime?
  passwordResetBy       String?
  
  // Account lifecycle
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt @default(now())
  lastLoginAt      DateTime?
  isDeleted        Boolean @default(false)
  deletedAt        DateTime?
  deletedBy        String?

  // Relations
  tenant                    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  approvalRequests         UserApprovalRequest[] @relation("UserRequests")
  requestedApprovals       UserApprovalRequest[] @relation("RequestedBy")
  reviewedApprovals        UserApprovalRequest[] @relation("ReviewedBy")
  tenantApprovalRequests   TenantApprovalRequest[]
  
  // Procedure relations
  createdTemplates         ProcedureTemplate[] @relation("CreatedTemplates")
  assignedProcedures       AuditProcedure[] @relation("AssignedProcedures")
  assignedByProcedures     AuditProcedure[] @relation("AssignedByUser")
  reviewedProcedures       AuditProcedure[] @relation("ReviewedProcedures")
  createdProcedures        AuditProcedure[] @relation("CreatedProcedures")
  preparedWorkpapers       Workpaper[] @relation("PreparedWorkpapers")
  reviewedWorkpapers       Workpaper[] @relation("ReviewedWorkpapers")
  identifiedFindings       Finding[] @relation("IdentifiedFindings")
  resolvedFindings         Finding[] @relation("ResolvedFindings")
  procedureComments        ProcedureComment[] @relation("ProcedureComments")

  @@unique([tenantId, email])
  @@map("tenant_users")
}

model Subscription {
  id                 String             @id @default(cuid())
  tenantId           String
  planId             String
  status             SubscriptionStatus
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  createdAt          DateTime           @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("subscriptions")
}

model UsageMetric {
  id          String   @id @default(cuid())
  tenantId    String
  metricName  String
  metricValue BigInt
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, metricName, periodStart])
  @@map("usage_metrics")
}

// =============================================================================
// CORE BUSINESS MODELS
// =============================================================================
// Company, Period, and fundamental business entities

// Individual tenant database schema (replicated per tenant)
model Company {
  id        String  @id @default(cuid())
  name      String
  code      String
  shortName String?

  // Contact information
  address      String?
  addressLine1 String?
  addressLine2 String?
  addressLine3 String?
  phone        String?
  fax          String?
  email        String?
  website      String?

  // Primary contact
  contactPerson      String?
  contactDesignation String?
  contactPhone       String?
  contactEmail       String?

  // Business details
  businessType   String?
  baseCurrency   String?
  currencyId     Int?
  industrySector String?
  fiscalYearEnd  DateTime?
  
  // Registration details
  registrationNumber String?
  taxId             String?
  industry          String?
  
  // Tenant isolation
  tenantId       String?

  // Status
  status   CompanyStatus @default(ACTIVE)
  isActive Boolean       @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?
  version   Int      @default(1)
  isDeleted Boolean  @default(false)

  // Relations
  periods             Period[]
  accountHeads        AccountHead[]
  procedures          Procedure[]
  documents           Document[]
  journalEntries      JournalEntry[]
  trialBalanceEntries TrialBalanceEntry[]
  reports             Report[]
  configurations      Configuration[]
  importJobs          ImportJob[] @relation("ImportJobs")
  exportJobs          ExportJob[] @relation("ExportJobs")
  auditLogs          AuditLog[] @relation("AuditLogCompany")
  alerts             Alert[]     // Add alerts relation
  ledgerEntries      Ledger[]
  auditProcedures    AuditProcedure[]
  findings           Finding[]

  @@unique([code])
  @@map("companies")
}

model Period {
  id        String    @id @default(cuid())
  companyId String
  name      String
  startDate DateTime
  endDate   DateTime
  auditType AuditType

  // Period status
  status      PeriodStatus @default(OPEN)
  isCurrent   Boolean      @default(false)
  isActive    Boolean      @default(true)
  closedDate  DateTime?
  description String?
  fiscalYear  String?
  periodType  String?
  
  // Tenant isolation
  tenantId    String?

  // Audit parameters
  materialityAmount     Decimal? @db.Decimal(15, 2)
  materialityPercentage Decimal? @db.Decimal(5, 2)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  // Relations
  company        Company             @relation(fields: [companyId], references: [id])
  trialBalance   TrialBalanceEntry[]
  journalEntries JournalEntry[]
  procedures     Procedure[]
  documents      Document[]
  reports        Report[]
  accountHeads   AccountHead[]       @relation("PeriodAccountHeads")
  auditLogs     AuditLog[] @relation("AuditLogPeriod")
  exportJobs    ExportJob[] @relation("ExportJobPeriod")
  importJobs    ImportJob[] @relation("ImportJobPeriod")
  ledgerEntries  Ledger[]
  auditProcedures AuditProcedure[]
  findings       Finding[]

  @@unique([companyId, name])
  @@map("periods")
}

// =============================================================================
// CHART OF ACCOUNTS & FINANCIAL MODELS
// =============================================================================
// Account types, account heads, trial balance, and journal entries

model AccountType {
  id            Int             @id @default(autoincrement())
  name          String
  code          String          @unique
  category      AccountCategory
  normalBalance BalanceType
  displayOrder  Int?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())

  accountHeads AccountHead[]

  @@map("account_types")
}

model AccountHead {
  id                    String        @id @default(cuid())
  companyId             String
  periodId              String?       // Add periodId field  
  tenantId              String?       // Add tenantId field
  accountTypeId         Int               // Make required for relation
  accountTypeString     String?           // For string-based service operations
  accountNumber         String?           // Account number field
  accountName           String?           // Add accountName alias for name
  name                  String
  code                  String?
  subType               String?           // Add subType field
  description           String?
  parentAccountId       String?
  level                 Int           @default(1)
  trialBalanceOrder     Int?
  includeInTrialBalance Boolean       @default(true)
  openingBalance        Decimal       @default(0) @db.Decimal(15, 2)
  currentBalance        Decimal       @default(0) @db.Decimal(15, 2)
  status                AccountStatus @default(ACTIVE)
  isActive              Boolean       @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  // Relations
  company             Company             @relation(fields: [companyId], references: [id])
  period              Period?             @relation("PeriodAccountHeads", fields: [periodId], references: [id])
  tenant              Tenant?             @relation("TenantAccountHeads", fields: [tenantId], references: [id])
  accountType         AccountType         @relation(fields: [accountTypeId], references: [id])
  parentAccount       AccountHead?        @relation("AccountHierarchy", fields: [parentAccountId], references: [id])
  childAccounts       AccountHead[]       @relation("AccountHierarchy")
  journalLineItems    JournalLineItem[]
  journalEntries      JournalEntry[]      @relation("AccountJournalEntries")
  procedures          Procedure[]
  documents           Document[]
  trialBalanceAccountHead TrialBalanceEntry[] @relation("TrialBalanceAccountHead")
  ledgerEntries       Ledger[]

  @@unique([companyId, code])
  @@map("account_heads")
}

model TrialBalanceEntry {
  id        String @id @default(cuid())
  companyId String
  periodId  String
  accountId String
  asOfDate  DateTime?

  // Balance amounts
  openingDebit     Decimal @default(0) @db.Decimal(15, 2)
  openingCredit    Decimal @default(0) @db.Decimal(15, 2)
  periodDebit      Decimal @default(0) @db.Decimal(15, 2)
  periodCredit     Decimal @default(0) @db.Decimal(15, 2)
  closingDebit     Decimal @default(0) @db.Decimal(15, 2)
  closingCredit    Decimal @default(0) @db.Decimal(15, 2)
  adjustmentDebit  Decimal @default(0) @db.Decimal(15, 2)
  adjustmentCredit Decimal @default(0) @db.Decimal(15, 2)
  
  // Additional computed fields for compatibility
  debitBalance     Decimal @default(0) @db.Decimal(15, 2)
  creditBalance    Decimal @default(0) @db.Decimal(15, 2)

  // Status
  isBalanced  Boolean  @default(true)
  lastUpdated DateTime @default(now())
  updatedBy   String?

  // Relations
  company     Company     @relation(fields: [companyId], references: [id])
  period      Period      @relation(fields: [periodId], references: [id])
  accountHead AccountHead @relation("TrialBalanceAccountHead", fields: [accountId], references: [id])

  @@unique([companyId, periodId, accountId])
  @@map("trial_balance")
}

model JournalEntry {
  id              String        @id @default(cuid())
  companyId       String
  periodId        String
  accountId       String?       // Add accountId field for compatibility
  tenantId        String?       // Add tenantId field
  journalNumber   String
  entryNumber     String?
  entryDate       DateTime
  journalDate     DateTime
  referenceNumber String?
  description     String?
  notes           String?       // Add notes field
  journalType     JournalType   @default(ADJUSTMENT)
  entryType       String?       // Add entryType for compatibility
  amount          Decimal?      @db.Decimal(15, 2) // Add amount for compatibility
  totalDebit      Decimal       @default(0) @db.Decimal(15, 2)
  totalCredit     Decimal       @default(0) @db.Decimal(15, 2)
  status          JournalStatus @default(DRAFT)
  isPosted        Boolean       @default(false)
  reviewNotes     String?
  reviewedBy      String?       // Add reviewedBy field
  reviewedAt      DateTime?     // Add reviewedAt field
  referenceDocumentId String?   // Add referenceDocument field

  // Metadata
  createdAt DateTime  @default(now())
  createdBy String?
  updatedBy String?
  postedAt  DateTime?
  postedBy  String?

  // Relations
  company   Company           @relation(fields: [companyId], references: [id])
  period    Period            @relation(fields: [periodId], references: [id])
  account   AccountHead?      @relation("AccountJournalEntries", fields: [accountId], references: [id])
  lineItems JournalLineItem[]
  referenceDocument Document? @relation("JournalEntryReferences", fields: [referenceDocumentId], references: [id])
  ledgerEntries Ledger[]

  @@unique([companyId, journalNumber])
  @@map("journal_entries")
}

model JournalLineItem {
  id             String  @id @default(cuid())
  journalEntryId String
  accountId      String
  lineNumber     Int
  description    String?
  debitAmount    Decimal @default(0) @db.Decimal(15, 2)
  creditAmount   Decimal @default(0) @db.Decimal(15, 2)
  reference      String?
  createdAt      DateTime @default(now())
  createdBy      String?
  updatedBy      String?

  // Relations
  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      AccountHead  @relation(fields: [accountId], references: [id])
  ledgerEntries Ledger[]

  @@map("journal_line_items")
}

// =============================================================================
// GENERAL LEDGER MODEL
// =============================================================================
// Ledger entries for tracking account transactions and running balances

model Ledger {
  id              String   @id @default(cuid())
  companyId       String
  periodId        String
  accountId       String
  journalEntryId  String
  lineItemId      String
  tenantId        String
  
  // Transaction details
  transactionDate DateTime
  journalNumber   String
  description     String?
  reference       String?
  
  // Amounts
  debitAmount     Decimal  @default(0) @db.Decimal(15, 2)
  creditAmount    Decimal  @default(0) @db.Decimal(15, 2)
  runningBalance  Decimal  @default(0) @db.Decimal(15, 2)
  
  // Sequencing
  sequenceNumber  Int
  
  // Metadata
  createdAt       DateTime @default(now())
  createdBy       String?
  
  // Relations
  company      Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  period       Period           @relation(fields: [periodId], references: [id], onDelete: Cascade)
  account      AccountHead      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  journalEntry JournalEntry     @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  lineItem     JournalLineItem  @relation(fields: [lineItemId], references: [id], onDelete: Cascade)

  @@unique([companyId, accountId, periodId, sequenceNumber])
  @@index([companyId, accountId, periodId, transactionDate])
  @@index([journalEntryId])
  @@index([tenantId])
  @@map("ledger")
}

// =============================================================================
// AUDIT PROCEDURES & WORKFLOW MODELS
// =============================================================================
// Templates, procedures, and audit workflow management

model ProcedureTemplate {
  id             String   @id @default(cuid())
  tenantId       String?  // Make optional for backwards compatibility
  name           String
  description    String?
  category       String?
  procedureText  String
  isMandatory    Boolean  @default(false)
  estimatedHours Decimal? @db.Decimal(5, 2)
  requiredSkills Json?
  isActive       Boolean  @default(true)
  version        Int      @default(1)
  createdBy      String?  // Add createdBy field
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  tenant          Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator         TenantUser? @relation("CreatedTemplates", fields: [createdBy], references: [id])
  procedures      Procedure[]
  auditProcedures AuditProcedure[]

  @@map("procedure_templates")
}

model Procedure {
  id         String  @id @default(cuid())
  companyId  String
  periodId   String
  templateId String?
  accountId  String?

  // Procedure details
  name          String
  description   String?
  procedureType String?

  // Assignment and tracking
  assignedTo     String?
  assignedDate   DateTime?
  dueDate        DateTime?
  estimatedHours Decimal?  @db.Decimal(5, 2)
  actualHours    Decimal?  @db.Decimal(5, 2)

  // Status tracking
  status               ProcedureStatus @default(NOT_STARTED)
  completionPercentage Int             @default(0)
  isActive             Boolean         @default(true)

  // Review process
  reviewStatus ReviewStatus @default(NOT_REVIEWED)
  reviewerId   String?
  reviewedDate DateTime?
  reviewNotes  String?

  // Final sign-off
  signedOffBy   String?
  signedOffDate DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  // Relations
  company   Company            @relation(fields: [companyId], references: [id])
  period    Period             @relation(fields: [periodId], references: [id])
  template  ProcedureTemplate? @relation(fields: [templateId], references: [id])
  account   AccountHead?       @relation(fields: [accountId], references: [id])
  assignee  User?              @relation("ProcedureAssignee", fields: [assignedTo], references: [id])
  reviewer  User?              @relation("ProcedureReviewer", fields: [reviewerId], references: [id])
  creator   User?              @relation("ProcedureCreator", fields: [createdBy], references: [id])
  documents Document[]

  @@map("procedures")
}

model AuditProcedure {
  id                String @id @default(cuid())
  tenantId          String
  companyId         String
  periodId          String
  templateId        String?
  name              String
  description       String? @db.Text
  category          ProcedureCategory
  riskLevel         RiskLevel
  status            ProcedureStatus @default(NOT_STARTED)
  priority          Priority @default(MEDIUM)
  
  // Assignment
  assignedToId      String?
  assignedBy        String?
  assignedAt        DateTime?
  dueDate           DateTime?
  
  // Completion
  startedAt         DateTime?
  completedAt       DateTime?
  actualHours       Float?
  
  // Review
  reviewStatus      ReviewStatus @default(NOT_REVIEWED)
  reviewedBy        String?
  reviewedAt        DateTime?
  reviewNotes       String? @db.Text
  
  createdBy         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  tenant            Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  period            Period @relation(fields: [periodId], references: [id], onDelete: Cascade)
  template          ProcedureTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  assignedTo        TenantUser? @relation("AssignedProcedures", fields: [assignedToId], references: [id], onDelete: SetNull)
  assigner          TenantUser? @relation("AssignedByUser", fields: [assignedBy], references: [id])
  reviewer          TenantUser? @relation("ReviewedProcedures", fields: [reviewedBy], references: [id])
  creator           TenantUser @relation("CreatedProcedures", fields: [createdBy], references: [id])
  
  workpapers        Workpaper[]
  findings          Finding[]
  comments          ProcedureComment[]

  @@index([tenantId])
  @@index([companyId])
  @@index([periodId])
  @@index([assignedToId])
  @@index([status])
  @@map("audit_procedures")
}

model Workpaper {
  id                String @id @default(cuid())
  procedureId       String
  tenantId          String
  title             String
  content           String @db.Text
  preparedBy        String
  preparedAt        DateTime @default(now())
  reviewedBy        String?
  reviewedAt        DateTime?
  reviewNotes       String? @db.Text
  version           Int @default(1)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  tenant            Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  procedure         AuditProcedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  preparer          TenantUser @relation("PreparedWorkpapers", fields: [preparedBy], references: [id])
  reviewer          TenantUser? @relation("ReviewedWorkpapers", fields: [reviewedBy], references: [id])
  attachments       Document[]

  @@index([tenantId])
  @@index([procedureId])
  @@map("workpapers")
}

model Finding {
  id                String @id @default(cuid())
  procedureId       String
  tenantId          String
  companyId         String
  periodId          String
  title             String
  description       String @db.Text
  severity          Severity
  status            FindingStatus @default(OPEN)
  recommendation    String? @db.Text
  managementResponse String? @db.Text
  
  identifiedBy      String
  identifiedAt      DateTime @default(now())
  resolvedBy        String?
  resolvedAt        DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  tenant            Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  procedure         AuditProcedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  period            Period @relation(fields: [periodId], references: [id], onDelete: Cascade)
  identifier        TenantUser @relation("IdentifiedFindings", fields: [identifiedBy], references: [id])
  resolver          TenantUser? @relation("ResolvedFindings", fields: [resolvedBy], references: [id])

  @@index([tenantId])
  @@index([procedureId])
  @@index([companyId])
  @@index([status])
  @@index([severity])
  @@map("findings")
}

model ProcedureComment {
  id                String @id @default(cuid())
  procedureId       String
  tenantId          String
  userId            String
  comment           String @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  tenant            Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  procedure         AuditProcedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  user              TenantUser @relation("ProcedureComments", fields: [userId], references: [id])

  @@index([tenantId])
  @@index([procedureId])
  @@map("procedure_comments")
}

// =============================================================================
// DOCUMENT MANAGEMENT MODELS
// =============================================================================
// Document storage, versioning, and access control

model Document {
  id          String  @id @default(cuid())
  tenantId    String
  companyId   String
  periodId    String?
  accountId   String?
  procedureId String?
  workpaperId String?  // Add workpaper reference

  // Document metadata
  name             String
  description      String?
  originalFilename String?
  fileExtension    String?
  mimeType         String?
  fileSizeBytes    BigInt?
  fileSize         BigInt?    // Add fileSize alias

  // Document classification  
  type           DocumentType
  status         DocumentStatus @default(PENDING)
  tags           String[]       @default([])
  category       String?
  classification Classification @default(CONFIDENTIAL)

  // Storage information
  storageProvider String  @default("local")
  storagePath     String?
  storageBucket   String?
  filePath        String? // Add filePath field

  // Version control
  version          Int     @default(1)
  isCurrentVersion Boolean @default(true)
  parentDocumentId String?

  // Review and approval
  reviewNotes String?
  reviewedBy  String?
  reviewedAt  DateTime?
  approvedBy  String?
  approvedAt  DateTime?

  // Security
  accessLevel       AccessLevel @default(INTERNAL)
  passwordProtected Boolean     @default(false)

  // Metadata
  createdAt      DateTime  @default(now()) // Add createdAt field
  uploadedAt     DateTime  @default(now())
  uploadedBy     String
  lastAccessedAt DateTime?
  updatedAt      DateTime  @updatedAt

  // Relations
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  period         Period?      @relation(fields: [periodId], references: [id], onDelete: SetNull)
  account        AccountHead? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  procedure      Procedure?   @relation(fields: [procedureId], references: [id], onDelete: SetNull)
  workpaper      Workpaper?   @relation(fields: [workpaperId], references: [id], onDelete: SetNull)
  uploader       User         @relation(fields: [uploadedBy], references: [id])
  reviewer       User?        @relation("DocumentReviewer", fields: [reviewedBy], references: [id])
  approver       User?        @relation("DocumentApprover", fields: [approvedBy], references: [id])
  parentDocument Document?    @relation("DocumentVersions", fields: [parentDocumentId], references: [id])
  childDocuments Document[]   @relation("DocumentVersions")
  journalEntryReferences JournalEntry[] @relation("JournalEntryReferences")

  @@map("documents")
}

// =============================================================================
// USER MANAGEMENT & SECURITY MODELS
// =============================================================================
// Users, roles, permissions, and security features

model User {
  id           String @id @default(cuid())
  email        String @unique
  passwordHash String
  password     String? // For compatibility

  // Personal information
  firstName  String
  lastName   String
  middleName String?
  jobTitle   String?
  department String?
  employeeId String?

  // Contact information
  phone  String?
  mobile String?

  // System access
  role        UserRole @default(AUDITOR)
  permissions Json     @default("[]")
  isActive    Boolean  @default(true)
  
  // Tenant isolation
  tenantId    String?

  // Session management
  lastLoginAt    DateTime?
  lastActivityAt DateTime?
  loginAttempts  Int       @default(0)
  lockedUntil    DateTime?

  // Preferences
  timezone String @default("UTC")
  language String @default("en")
  theme    String @default("light")

  // Password policy
  passwordChangedAt  DateTime @default(now())
  mustChangePassword Boolean  @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  documentsUploaded Document[]
  documentsReviewed Document[] @relation("DocumentReviewer")
  documentsApproved Document[] @relation("DocumentApprover")
  tenant            Tenant?    @relation(fields: [tenantId], references: [id])
  configurations    Configuration[]
  reports           Report[]   @relation("ReportCreator")
  exportJobs        ExportJob[] @relation("ExportJobCreator")
  importJobs        ImportJob[] @relation("ImportJobCreator")
  assignedProcedures Procedure[] @relation("ProcedureAssignee")
  reviewedProcedures Procedure[] @relation("ProcedureReviewer")
  createdProcedures Procedure[] @relation("ProcedureCreator")
  auditLogs         AuditLog[] @relation("AuditLogUser")
  alerts            Alert[]     // Add alerts relation

  @@map("users")
}

model Alert {
  id          String      @id @default(cuid())
  companyId   String
  title       String
  message     String
  alertType   String
  category    String?     // Add category field
  entityId    String?     // Add entityId field
  entityType  String?     // Add entityType field
  acknowledged Boolean    @default(false) // Add acknowledged field
  acknowledgedAt DateTime? // Add acknowledgedAt field
  actionRequired Boolean  @default(false) // Add actionRequired field
  severity    AuditSeverity
  isRead      Boolean     @default(false)
  userId      String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdBy   String

  // Relations
  company Company @relation(fields: [companyId], references: [id])
  creator User    @relation(fields: [createdBy], references: [id])
  
  @@map("alerts")
}

// =============================================================================
// DATA IMPORT/EXPORT & JOB MANAGEMENT
// =============================================================================
// Background jobs for data processing and file operations

// Note: TrialBalance alias handled in service layer for legacy compatibility

model ImportJob {
  id          String         @id @default(cuid())
  companyId   String
  name        String
  filename    String
  filePath    String?        // Add filePath field
  format      String?        // Add format field
  dataType    String?
  periodId    String?        // Add periodId field
  options     Json?          // Add options field
  status      ImportJobStatus @default(PENDING)
  progress    Int            @default(0)
  totalRecords Int?
  processedRecords Int?
  updatedRecords Int?        // Add updatedRecords field
  errorRecords Int?
  invalidRecords Int?        // Add invalidRecords field
  createdRecords Int?
  validRecords Int?          // Add validRecords field
  skippedRecords Int?        // Add skippedRecords field
  validationErrors Json?     // Add validationErrors field
  startedAt   DateTime?
  completedAt DateTime?
  errorDetails Json?
  error       String?
  emailOnComplete String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  createdBy   String

  creator User @relation("ImportJobCreator", fields: [createdBy], references: [id])
  company Company @relation("ImportJobs", fields: [companyId], references: [id])
  period  Period? @relation("ImportJobPeriod", fields: [periodId], references: [id])

  @@map("import_jobs")
}

model ExportJob {
  id          String         @id @default(cuid())
  companyId   String
  name        String
  filename    String
  format      String?        // Add format field
  dataTypes   Json?          // Add dataTypes field
  periodId    String?        // Add periodId field
  startDate   DateTime?      // Add startDate field
  endDate     DateTime?      // Add endDate field
  options     Json?          // Add options field
  scheduledFor DateTime?     // Add scheduledFor field
  status      ExportJobStatus @default(PENDING)
  progress    Int            @default(0)
  totalRecords Int?
  processedRecords Int?
  startedAt   DateTime?
  completedAt DateTime?
  downloadUrl String?
  expiresAt   DateTime?
  filePath    String?
  fileSize    BigInt?        // Add fileSize field
  error       String?
  emailOnComplete String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  createdBy   String

  creator User @relation("ExportJobCreator", fields: [createdBy], references: [id])
  company Company @relation("ExportJobs", fields: [companyId], references: [id])
  period  Period? @relation("ExportJobPeriod", fields: [periodId], references: [id])

  @@map("export_jobs")
}

// =============================================================================
// REPORTING & CONFIGURATION MODELS
// =============================================================================
// Reports, templates, system configuration, and audit logging

model Report {
  id          String      @id @default(cuid())
  companyId   String
  periodId    String?
  name        String
  description String?
  reportType  ReportType
  templateId  String?
  parameters  Json        @default("{}")
  filters     Json?
  configuration Json?
  recipients  Json?
  format      String?
  schedule    Json?       // Add schedule field
  generatedAt DateTime?
  status      ReportStatus @default(DRAFT)
  fileUrl     String?
  isActive    Boolean     @default(true)  // Add isActive field
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdBy   String
  updatedBy   String?     // Add updatedBy field

  company Company @relation(fields: [companyId], references: [id])
  period  Period? @relation(fields: [periodId], references: [id])
  creator User    @relation("ReportCreator", fields: [createdBy], references: [id])

  @@map("reports")
}

model Configuration {
  id          String   @id @default(cuid())
  companyId   String?
  key         String
  value       Json
  name        String?   // Add name field
  type        String?   // Add type field
  settings    Json?     // Add settings field
  description String?
  category    String?
  isSystem    Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?

  company Company? @relation(fields: [companyId], references: [id])
  creator User?    @relation(fields: [createdBy], references: [id])

  @@unique([companyId, key])
  @@map("configurations")
}

model ImportTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?  // Add description field
  dataType    String
  format      String?  // Add format field
  fieldMapping Json    @default("{}")
  fieldMappings Json?   // Add fieldMappings alias
  defaultOptions Json?  // Add defaultOptions field
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String

  @@map("import_templates")
}

model AuditLog {
  id String @id @default(cuid())

  // Required core fields
  tableName  String
  recordId   String 
  action     AuditAction

  // Optional entity information
  eventType  String?     // Add eventType field
  entityType String?     // Add entityType field  
  entityId   String?     // Add entityId field

  // Change details
  oldValues Json?
  newValues Json?
  hash      String? // Add hash field for audit trail integrity
  previousHash String? // Add previousHash field

  // User context
  userId    String?
  userEmail String?
  companyId String?     // Add companyId field
  periodId  String?     // Add periodId field

  // Session context
  sessionId String?
  ipAddress String?
  userAgent String?

  // Request context
  requestId  String?
  endpoint   String?
  httpMethod String?

  // Description and metadata  
  description String?   // Add description field
  tags        String?   // Add tags field (JSON string)
  metadata    String?   // Add metadata field (JSON string)
  severity    AuditSeverity @default(LOW)
  status      String?   // Add status field

  // Timing
  timestamp        DateTime @default(now())
  processingTimeMs Int?

  // Classification
  riskLevel          RiskLevel @default(LOW)
  complianceRelevant Boolean   @default(false)

  // Retention
  retentionPeriod String    @default("7 years")
  archivedAt      DateTime?

  // Relations
  user    User?    @relation("AuditLogUser", fields: [userId], references: [id], onDelete: SetNull)
  company Company? @relation("AuditLogCompany", fields: [companyId], references: [id], onDelete: SetNull)
  period  Period?  @relation("AuditLogPeriod", fields: [periodId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// =============================================================================
// ENUM DEFINITIONS
// =============================================================================
// All enumerated types used throughout the system
enum TenantStatus {
  PENDING
  ACTIVE
  INACTIVE
  SUSPENDED
  CANCELLED
  TRIAL
  REJECTED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  UNPAID
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
}

enum PeriodStatus {
  OPEN
  PLANNING
  IN_PROGRESS
  CLOSED
  ARCHIVED
}

enum AuditType {
  ANNUAL
  INTERIM
  QUARTERLY
}

enum AccountCategory {
  ASSETS
  LIABILITIES
  EQUITY
  REVENUE
  EXPENSES
}

enum BalanceType {
  DEBIT
  CREDIT
}

enum AccountStatus {
  ACTIVE
  INACTIVE
}

enum JournalType {
  ADJUSTMENT
  RECLASSIFICATION
  ERROR_CORRECTION
}

enum JournalStatus {
  DRAFT
  POSTED
  REVERSED
}

enum ProcedureStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  REVIEW_REQUIRED
  CANCELLED  // Added
}

enum ReviewStatus {
  NOT_REVIEWED
  IN_REVIEW
  REVIEWED
  APPROVED
  REJECTED  // Added
  REQUIRES_CHANGES  // Added
}

enum Classification {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  RESTRICTED
}

enum AccessLevel {
  PUBLIC
  INTERNAL
  RESTRICTED
}

enum UserRole {
  ADMIN
  MANAGER
  SENIOR_AUDITOR
  AUDITOR
  INTERN
  USER
}

enum AuditAction {
  INSERT
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  ACCESS
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DocumentType {
  FINANCIAL_STATEMENT
  TRIAL_BALANCE
  GENERAL_LEDGER
  BANK_STATEMENT
  INVOICE
  RECEIPT
  CONTRACT
  CORRESPONDENCE
  WORKING_PAPER
  MANAGEMENT_LETTER
  OTHER
}

enum DocumentStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
}

enum ImportJobStatus {
  PENDING
  VALIDATING
  IN_PROGRESS
  PROCESSING
  COMPLETED
  FAILED
  PARTIAL
  CANCELLED
}

enum ExportJobStatus {
  PENDING
  IN_PROGRESS
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ReportType {
  FINANCIAL_POSITION
  INCOME_STATEMENT
  CASH_FLOW
  TRIAL_BALANCE
  GENERAL_LEDGER
  AGED_RECEIVABLES
  AGED_PAYABLES
  JOURNAL_REGISTER
  AUDIT_SUMMARY
  PROCEDURE_STATUS
  FINDINGS_REPORT
  COMPLIANCE_REPORT
  RISK_ASSESSMENT
  BALANCE_SHEET
  AUDIT_REPORT
  MANAGEMENT_LETTER
  CUSTOM
}

enum ReportStatus {
  DRAFT
  GENERATING
  COMPLETED
  FAILED
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
  JSON
}

enum AuditSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
  WARNING
  INFO
  ERROR
}

enum ProcedureCategory {
  CASH_AND_BANK
  ACCOUNTS_RECEIVABLE
  INVENTORY
  FIXED_ASSETS
  ACCOUNTS_PAYABLE
  REVENUE
  EXPENSES
  EQUITY
  ANALYTICAL_PROCEDURES
  INTERNAL_CONTROLS
  COMPLIANCE
  SUBSTANTIVE_TESTING
  OTHER
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum Severity {
  MINOR
  MODERATE
  SIGNIFICANT
  MATERIAL
  CRITICAL
}

enum FindingStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  DEFERRED
}
